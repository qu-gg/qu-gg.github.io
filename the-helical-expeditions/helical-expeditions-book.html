<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> BREAK!! - The Helical Expeditions</title>
    <style>
        /* ===== BOOK COMPILER STYLES ===== */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            /* BREAK!! Title Page Theme */
            --break-pink: #e83a7a;
            --break-magenta: #c42d6b;
            --break-light-blue: #5bc0de;
            --break-sky: #87ceeb;
            --break-cyan: #00bcd4;
            --break-purple: #6b3fa0;
            --break-gold: #f5c542;
            --break-cream: #faf6ed;
            --break-light: #fff8f0;
            --break-dark: #2a1f3d;
        }

        @page {
            size: 8.5in 11in;
            margin: 0;
        }

        @media print {
            html, body {
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 8.5in;
            }
            
            #book-container {
                padding: 0 !important;
                margin: 0 !important;
            }

            .spread-container {
                display: block !important;
                background: none !important;
                padding: 0 !important;
                margin: 0 !important;
                box-shadow: none !important;
            }

            .solo-section {
                display: block !important;
            }
            
            .page-wrapper {
                display: block !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .page, .toc-page, .blank-filler {
                box-shadow: none !important;
                margin: 0 !important;
                width: 8.5in !important;
                min-height: 11in !important;
                max-height: 11in !important;
                page-break-after: always;
                page-break-inside: avoid;
            }
            
            .controls {
                display: none !important;
            }
            
            .page-number {
                background: white !important;
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }

            .hide-page-numbers .page-number {
                display: none !important;
            }
        }

        /* Force all pages including art-page to maintain consistent height */
        .page {
            width: 8.5in;
            min-height: 11in;
            max-height: 11in;
        }

        /* Hide individual page credits in compiled book view */
        .page-credit {
            display: none !important;
        }

        html, body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 10pt;
            line-height: 1.35;
            background: #555;
        }

        /* ===== CONTROL PANEL ===== */
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--break-dark);
            padding: 20px;
            border-radius: 12px;
            z-index: 1000;
            color: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            max-width: 280px;
        }

        .controls h3 {
            margin-bottom: 15px;
            color: var(--break-pink);
            font-size: 14pt;
        }

        .controls label {
            display: block;
            margin-bottom: 8px;
            font-size: 9pt;
        }

        .controls button {
            width: 100%;
            padding: 10px 15px;
            margin-top: 10px;
            background: linear-gradient(135deg, var(--break-purple), var(--break-pink));
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(232, 58, 122, 0.4);
        }

        .controls .toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            font-size: 10pt;
        }

        .controls .toggle-label input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--break-pink);
        }

        .controls .status {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            font-size: 8pt;
        }

        /* ===== BOOK CONTAINER ===== */
        #book-container {
            padding: 20px;
            padding-right: 320px;
        }

        /* ===== SPREAD VIEW (Side-by-side pages) ===== */
        .spread-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 4px;
            margin-bottom: 20px;
            background: #333;
            padding: 10px;
            border-radius: 4px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
            align-items: stretch;
        }

        .spread-container .adventure-section,
        .spread-container .page-wrapper {
            margin: 0;
            flex-shrink: 0;
        }

        .spread-container .page,
        .spread-container .toc-page,
        .spread-container .blank-filler {
            margin: 0;
            height: 11in;
        }

        /* Progress bubbles positioning - move to outer edge for book binding */
        /* Left pages (first child in spread) - bubbles on left */
        .spread-container > :first-child .page-progress,
        .spread-container > :first-child .page .page-progress {
            right: auto;
            left: 0.12in;
        }

        /* Right pages (last child in spread) - bubbles stay on right (default) */
        .spread-container > :last-child .page-progress,
        .spread-container > :last-child .page .page-progress {
            left: auto;
            right: 0.12in;
        }

        /* Solo pages (title, toc) */
        .solo-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #333;
            padding: 10px;
            border-radius: 4px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .solo-section .page-wrapper {
            margin-bottom: 10px;
        }

        .solo-section .page-wrapper:last-child {
            margin-bottom: 0;
        }

        /* ===== PAGE NUMBER STYLING ===== */
        .page-wrapper {
            position: relative;
            display: inline-block;
        }

        .page-number {
            position: absolute;
            bottom: 0.15in;
            font-family: 'Trebuchet MS', sans-serif;
            font-size: 14pt;
            font-weight: bold;
            color: #1a1a1a;
            z-index: 100;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page-number-left {
            left: 0.15in;
        }

        .page-number-right {
            right: 0.15in;
        }

        /* Toggle for hiding page numbers */
        .hide-page-numbers .page-number {
            display: none !important;
        }

        /* Toggle for hiding gradient splashes */
        .hide-gradient-splash .toc-page {
            background: var(--break-cream) !important;
        }

        .hide-gradient-splash .blank-filler {
            background: #e8e4db !important;
        }

        .hide-gradient-splash .subzone-separator-left,
        .hide-gradient-splash .subzone-separator-right {
            background: #f5f0e6 !important;
        }

        .hide-gradient-splash .guide-section .page {
            background: var(--break-cream) !important;
        }

        .hide-gradient-splash .reference-section .page {
            background: var(--break-cream) !important;
        }

        /* ===== BLANK FILLER PAGE ===== */
        .page.blank-filler {
            width: 8.5in;
            min-height: 11in;
            max-height: 11in;
            background: 
                radial-gradient(circle at 0% 0%, rgba(91, 192, 222, 0.08) 0%, transparent 35%),
                radial-gradient(circle at 100% 0%, rgba(232, 58, 122, 0.06) 0%, transparent 35%),
                radial-gradient(circle at 100% 100%, rgba(91, 192, 222, 0.08) 0%, transparent 35%),
                radial-gradient(circle at 0% 100%, rgba(232, 58, 122, 0.06) 0%, transparent 35%),
                #e8e4db;
            margin: 0 auto 5mm auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            position: relative;
            page-break-after: always;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .blank-filler::before {
            content: '';
            position: absolute;
            top: 0.3in;
            left: 0.3in;
            width: 0.6in;
            height: 0.6in;
            border-left: 3px solid rgba(232, 58, 122, 0.2);
            border-top: 3px solid rgba(232, 58, 122, 0.2);
        }

        .blank-filler::after {
            content: '';
            position: absolute;
            bottom: 0.3in;
            right: 0.3in;
            width: 0.6in;
            height: 0.6in;
            border-right: 3px solid rgba(91, 192, 222, 0.2);
            border-bottom: 3px solid rgba(91, 192, 222, 0.2);
        }

        .blank-filler .filler-decoration {
            width: 80px;
            height: 80px;
            opacity: 0.15;
            background: 
                linear-gradient(45deg, transparent 40%, var(--break-pink) 40%, var(--break-pink) 60%, transparent 60%),
                linear-gradient(-45deg, transparent 40%, var(--break-light-blue) 40%, var(--break-light-blue) 60%, transparent 60%);
            border-radius: 50%;
        }

        /* Themed filler pages - matches adventure art vibeboard colors */
        .blank-filler.themed-filler {
            --filler-accent-1: rgba(255, 255, 255, 0.3);
            --filler-accent-2: rgba(255, 255, 255, 0.3);
            background: var(--themed-bg) !important;
        }

        .blank-filler.themed-filler::before {
            border-left-color: var(--filler-accent-1);
            border-top-color: var(--filler-accent-1);
        }

        .blank-filler.themed-filler::after {
            border-right-color: var(--filler-accent-2);
            border-bottom-color: var(--filler-accent-2);
        }

        .blank-filler.themed-filler .filler-decoration {
            display: none;
        }

        /* ===== TABLE OF CONTENTS ===== */
        .toc-page {
            width: 8.5in;
            min-height: 11in;
            max-height: 11in;
            padding: 0.5in 0.6in;
            background: 
                radial-gradient(circle at 0% 0%, rgba(91, 192, 222, 0.15) 0%, transparent 35%),
                radial-gradient(circle at 100% 0%, rgba(232, 58, 122, 0.1) 0%, transparent 35%),
                radial-gradient(circle at 100% 100%, rgba(91, 192, 222, 0.15) 0%, transparent 35%),
                radial-gradient(circle at 0% 100%, rgba(232, 58, 122, 0.1) 0%, transparent 35%),
                var(--break-cream);
            margin: 0 auto 5mm auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            position: relative;
            page-break-after: always;
        }

        .toc-page::before {
            content: '';
            position: absolute;
            top: 0.25in;
            left: 0.25in;
            width: 0.8in;
            height: 0.8in;
            border-left: 4px solid var(--break-pink);
            border-top: 4px solid var(--break-pink);
            opacity: 0.7;
        }

        .toc-page::after {
            content: '';
            position: absolute;
            bottom: 0.25in;
            right: 0.25in;
            width: 0.8in;
            height: 0.8in;
            border-right: 4px solid var(--break-light-blue);
            border-bottom: 4px solid var(--break-light-blue);
            opacity: 0.7;
        }

        .toc-header {
            text-align: center;
            margin-bottom: 0.4in;
        }

        .toc-header h2 {
            font-family: 'Impact', 'Arial Black', sans-serif;
            font-size: 28pt;
            color: var(--break-purple);
            text-transform: uppercase;
            letter-spacing: 4px;
            margin-bottom: 8px;
        }

        .toc-header .toc-subtitle {
            font-size: 11pt;
            color: var(--break-magenta);
            font-style: italic;
        }

        .toc-divider {
            width: 60%;
            height: 3px;
            margin: 0 auto 0.3in auto;
            background: linear-gradient(90deg, transparent, var(--break-pink), var(--break-light-blue), transparent);
            border-radius: 2px;
        }

        .toc-list {
            list-style: none;
        }

        .toc-region {
            margin-top: 0.2in;
            margin-bottom: 0.15in;
        }

        .toc-region:first-child {
            margin-top: 0;
        }

        .toc-front-matter {
            padding-bottom: 0.15in;
            border-bottom: 1px solid #ddd;
        }

        .toc-region-header {
            font-family: 'Impact', 'Arial Black', sans-serif;
            font-size: 14pt;
            color: var(--break-purple);
            text-transform: uppercase;
            letter-spacing: 2px;
            padding-bottom: 4px;
            border-bottom: 2px solid var(--break-pink);
            margin-bottom: 10px;
        }

        .toc-region-empty {
            font-size: 9pt;
            color: #999;
            font-style: italic;
            margin-left: 0.15in;
        }

        .toc-entry {
            display: flex;
            align-items: baseline;
            margin-bottom: 8px;
            margin-left: 0.15in;
            font-size: 11pt;
        }

        .toc-sub-entry {
            margin-left: 0.35in;
            font-size: 10pt;
        }

        .toc-sub-entry .toc-title {
            font-weight: normal;
            font-style: italic;
        }

        .toc-title {
            font-family: 'Trebuchet MS', sans-serif;
            font-weight: bold;
            color: var(--break-dark);
        }

        .toc-dots {
            flex-grow: 1;
            border-bottom: 2px dotted #ccc;
            margin: 0 10px 4px 10px;
            min-width: 40px;
        }

        .toc-page-num {
            flex-shrink: 0;
            font-family: 'Trebuchet MS', sans-serif;
            font-weight: bold;
            color: var(--break-purple);
            min-width: 25px;
            text-align: right;
        }

        .toc-sublocation {
            font-size: 9pt;
            color: #666;
            font-style: italic;
            margin-left: 0.15in;
            margin-bottom: 6px;
        }

        .toc-sublocation-empty {
            font-size: 9pt;
            color: #aaa;
            font-style: italic;
            margin-left: 0.15in;
            margin-bottom: 6px;
        }

        .toc-sublocation-empty::after {
            content: ' â€” coming soon';
            font-size: 8pt;
            color: #ccc;
        }

        /* TOC Page variants for spread */
        .toc-page-left {
            padding-top: 0.6in;
        }

        .toc-page-right {
            padding-top: 0.6in;
        }

        .toc-page-left .toc-header,
        .toc-page-right .toc-header {
            margin-bottom: 0.25in;
        }

        .toc-page-left .toc-header h2,
        .toc-page-right .toc-header h2 {
            font-size: 24pt;
        }

        .toc-rank {
            font-size: 8pt;
            color: var(--break-pink);
            font-weight: bold;
            margin-left: 6px;
            white-space: nowrap;
        }

        /* ===== REGIONAL SEPARATOR STYLES ===== */
        .region-separator-left,
        .region-separator-right {
            width: 8.5in;
            min-height: 11in;
            max-height: 11in;
            background: var(--region-bg);
            position: relative;
        }

        .region-separator-left::before,
        .region-separator-right::before {
            content: '';
            position: absolute;
            top: 0.25in;
            left: 0.25in;
            width: 0.7in;
            height: 0.7in;
            border-left: 4px solid var(--accent-primary);
            border-top: 4px solid var(--accent-primary);
            opacity: 0.8;
        }

        .region-separator-left::after,
        .region-separator-right::after {
            content: '';
            position: absolute;
            bottom: 0.25in;
            right: 0.25in;
            width: 0.7in;
            height: 0.7in;
            border-right: 4px solid var(--accent-secondary);
            border-bottom: 4px solid var(--accent-secondary);
            opacity: 0.8;
        }

        .region-separator-right {
            padding: 0.5in;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .region-title {
            font-family: 'Impact', 'Arial Black', sans-serif;
            font-size: 38pt;
            color: var(--title-color, #6b3fa0);
            text-transform: uppercase;
            letter-spacing: 5px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 8px;
        }

        .region-tagline {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            font-size: 10pt;
            color: var(--tagline-color, #2a1f3d);
            text-align: center;
            font-style: italic;
            max-width: 6in;
            margin: 0 auto 0.2in auto;
            line-height: 1.5;
        }

        .region-images {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 70%;
            margin: 0 auto;
        }

        .region-landscape {
            width: 100%;
            height: 1.7in;
            overflow: hidden;
            border-radius: 4px;
            border: 2px solid var(--image-border, #2d4a5e);
        }

        .region-landscape img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .region-portraits {
            display: flex;
            gap: 4px;
        }

        .region-portrait {
            flex: 1;
            height: 2.4in;
            overflow: hidden;
            border-radius: 4px;
            border: 2px solid var(--image-border, #2d4a5e);
        }

        .region-portrait img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ===== SUBZONE SEPARATOR STYLES ===== */
        .subzone-separator-left,
        .subzone-separator-right {
            width: 8.5in;
            min-height: 11in;
            max-height: 11in;
            background: var(--subzone-bg);
            position: relative;
        }

        .subzone-separator-left::before,
        .subzone-separator-right::before {
            content: '';
            position: absolute;
            top: 0.25in;
            left: 0.25in;
            width: 0.5in;
            height: 0.5in;
            border-left: 3px solid var(--subzone-accent);
            border-top: 3px solid var(--subzone-accent);
            opacity: 0.6;
        }

        .subzone-separator-left::after,
        .subzone-separator-right::after {
            content: '';
            position: absolute;
            bottom: 0.25in;
            right: 0.25in;
            width: 0.5in;
            height: 0.5in;
            border-right: 3px solid var(--subzone-accent);
            border-bottom: 3px solid var(--subzone-accent);
            opacity: 0.6;
        }

        .subzone-separator-right {
            padding: 1in 0.75in;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .subzone-title {
            font-family: 'Impact', 'Arial Black', sans-serif;
            font-size: 32pt;
            color: var(--subzone-title);
            text-transform: uppercase;
            letter-spacing: 4px;
            text-align: center;
            margin-bottom: 0.3in;
        }

        .subzone-divider {
            width: 3in;
            height: 3px;
            background: var(--subzone-accent);
            opacity: 0.5;
            margin-bottom: 0.4in;
            border-radius: 2px;
        }

        .subzone-flavor {
            font-family: 'Georgia', 'Times New Roman', serif;
            font-size: 12pt;
            color: var(--subzone-text);
            text-align: center;
            font-style: italic;
            max-width: 5.5in;
            line-height: 1.7;
        }

        /* ===== ADVENTURE SECTION WRAPPER ===== */
        .adventure-section {
            /* Contains scoped styles for each adventure */
            display: block;
        }

        /* Loading indicator */
        .loading {
            text-align: center;
            padding: 100px;
            color: white;
            font-size: 16pt;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <!-- Control Panel -->
    <div class="controls">
        <h3>ðŸ“– Book Compiler</h3>
        <label class="toggle-label">
            <input type="checkbox" id="showPageNumbers" onchange="togglePageNumbers()">
            <span>Show Page Numbers</span>
        </label>
        <label class="toggle-label">
            <input type="checkbox" id="showGradientSplash" onchange="toggleGradientSplash()">
            <span>Show Gradient Splashes</span>
        </label>
        <div class="status" id="status">Ready to compile...</div>
        <button onclick="compileBook()">Compile Book</button>
        <button onclick="window.print()">Print / Save PDF</button>
    </div>

    <!-- Book Container -->
    <div id="book-container" class="hide-page-numbers hide-gradient-splash">
        <div class="loading" id="loading">Loading adventures</div>
    </div>

    <script>
        // ===== REGION & ADVENTURE CONFIGURATION =====
        // Adventures are organized by region and sub-location
        // Reorder regions or adventures within regions to change book order
        // Title page is always first and not included here
        
        const bookStructure = {
            'Wistful Dark': {
                sublocations: ['Crystalia', 'Murk', 'Shard', 'Shadowed Lands', 'The Eaten Isle', 'Aiden', "Hollow Queen's Kingdom"],
                sublocationFlavor: {
                    'Crystalia': 'An isolated land of gossamer and glass. No one who has ventured there has returned. Some theorize it might be so beautiful that no one ever wants to leave.',
                    'Murk': "Home of the fey, said to contain portals that connect all the world's great forests together. The Formless Council of Unshaped meet here, devising ways to return the world to the era of Dreaming.",
                    'Shard': 'Shard Cities formed around the largest glowing fragments of the broken Sun Machine, the light and warmth from which attract the desperate. Shard Patricians control the cities, but the socio-economic influence of the Guilds and the Church of the Sacred Chain make ruling a delicate balancing act.',
                    'Shadowed Lands': 'There is no law or order in this haunting landscape of fungal forests and tundra. Nomads contend with the constant threat of the restless dead and desperate raiders. The rag-tag Knights of the Lantern attempt to protect those most in need.',
                    'The Eaten Isle': "This once divine place is devoid of rational life after a botched ritual. The isle's epicenter now sinks into a magical abyss.",
                    'Aiden': "This military confederacy repels the Hollow Queen's monstrous army from an ancient fortified wall that divides the dark continent. The Red Blades, the nation's elite troops, perform daring raids deep into enemy territory.",
                    "Hollow Queen's Kingdom": "The citizens of Calian were warped into twisted demons and wretches, and their glorious queen reduced to a miserable and spiteful creature. She commits her 'children' to a relentless attack on civilisation. Only Aiden stops the advance."
                },
                tagline: 'The furthest continent from the Sun Machine, a dark and<br>melancholy realm filled with an equal measure of fear and hope.',
                colors: {
                    panelBg: 'linear-gradient(135deg, #2a2440 0%, #1a1428 50%, #2a2440 100%)',
                    panelBorder: '#6b5b8c',
                    titleColor: '#c4b8d9',
                    taglineColor: '#a99bc2',
                    accentPrimary: '#8b7aab',
                    accentSecondary: '#5c4d7a',
                    imageBorder: '#6b5b8c'
                },
                images: {
                    landscape: 'Regional Images/page304_Wistful_Dark_image003.png',
                    portraits: [
                        'Regional Images/page304_Wistful_Dark_image001.png',
                        'Regional Images/page304_Wistful_Dark_image002.png',
                        'Regional Images/page304_Wistful_Dark_image004.png'
                    ]
                },
                adventures: [
                    {
                        file: '6-hold-the-wall.html',
                        title: 'Hold the Wall',
                        sublocation: 'Aiden',
                        location: 'The Red Wall',
                        rank: '8-9'
                    }
                ]
            },
            'The Twilight Meridian': {
                sublocations: ['Seven Holy Isles', 'Night Haven', 'Sunken Isles', 'Stahlfeld', 'Galvanus Archipelago'],
                sublocationFlavor: {
                    'Seven Holy Isles': 'A glorious land of art, ingenuity and perpetual strife. While recently united under the banner of the Shogun, the inhabitants still quarrel among each other. In Meikyuu, The City of Paths, there are whispers of a Shinobi rebellion.',
                    'Night Haven': "An artificial island constructed of Shade Iron and overrun with unearthly climbing flowers. The Duke of Red Roses, the island's immortal ruler, is charismatic and fair but there are suspicions about what goes on deep below the foreboding Castle Thornbeauty.",
                    'Sunken Isles': "Once considered a manifestation of the Technocracy's culture and benevolence, these floating cities were a way to expand their empire without conquest and conflict. The events of the 3rd Cataclysm left these constructs submerged.",
                    'Stahlfeld': 'Much of Stahlfeld is dotted with ruins of the fallen Technocracy of the Gley, where drones wander over rust-covered salvage yards. The few cities that exist here are home to brave and ambitious Junkers who make a prosperous, but risky, living unearthing Techno-Relics.',
                    'Galvanus Archipelago': "Known as the land of the Eternal Dawn, and considered the most beautiful place in all of Outer World, Galvanus is a series of prosperous islands that function as a global trading hub. Natural beauty is marred by the ugly truths of mercantile warfare and piracy."
                },
                tagline: 'On the cusp of dusk and dawn, the Twilight Meridian has no dominant<br>land mass but is instead a series of diverse and interrelated islands.',
                colors: {
                    panelBg: 'linear-gradient(135deg, #3d2942 0%, #1f3a4a 50%, #2a3f4f 100%)',
                    panelBorder: '#d4896a',
                    titleColor: '#f5c09a',
                    taglineColor: '#d4b8a8',
                    accentPrimary: '#e8a070',
                    accentSecondary: '#4a7a8a',
                    imageBorder: '#8a6a5a'
                },
                images: {
                    landscape: 'Regional Images/page306_Twilight_Meridian_image001.png',
                    portraits: [
                        'Regional Images/page306_Twilight_Meridian_image002.png',
                        'Regional Images/page306_Twilight_Meridian_image003.png',
                        'Regional Images/page306_Twilight_Meridian_image004.png'
                    ]
                },
                adventures: [
                    {
                        file: '2-danger-for-a-rokko-do.html',
                        title: 'Danger for a Rokko-Do',
                        sublocation: 'Seven Holy Isles',
                        location: 'Winding Pass',
                        rank: '2-3'
                    },
                    {
                        file: '5-sinking-float-stone.html',
                        title: 'Sinking the Float Stone Mine',
                        sublocation: 'Seven Holy Isles',
                        location: "Go Isle's Float Stone Mine",
                        rank: '5-6'
                    },
                    {
                        file: '1-fishy-business.html',
                        title: 'Deal with a Sea Witch',
                        sublocation: 'Sunken Isles',
                        location: 'Dia, Beneath the Waves',
                        rank: '7-8'
                    }
                ]
            },
            'Blazing Garden': {
                sublocations: ['Taaga', 'Thunda Sands', 'Sol Alliance', 'No-Folk Land', 'Pride Coast'],
                sublocationFlavor: {
                    'Taaga': 'The final resting place of the Dawn Dragon is a splendid land of lush greenery and clear waters. The region provides an abundance of natural resources for the local allied clans, which gives them the trading leverage to rival even the Galvanus Archipelago.',
                    'Thunda Sands': "Home to the unruly but courageous Thunda Barbarians, the sands are revered as a place of true freedom and high adventure. While you'll find respite in one of the region's oasis towns, you'll have to contend with the blistering heat, rampaging mechanical monsters, and the occasional resurrected Overlord.",
                    'Sol Alliance': 'Named after the broken Sun Machine that hangs above, the alliance is unified by the uncompromising vision and might of Emperor Regulus, the First Hero. The region is famed for its sparkling capital Aeon, the mightiest city, and its legion of ferocious young warriors.',
                    'No-Folk Land': 'Thanks to the colossal creatures that feed and roam freely in the region, No-Folk Land is regarded as an inhospitable place. Despite this, some enterprising individuals have managed to establish small settlements... only to find the neighboring towns are only marginally more amiable than the wandering beasts.',
                    'Pride Coast': 'This once small nation rose to prominence after the arrival and assimilation of the Rai-Neko and their strange Startech technology. Centered around Nyanko, the city that grew around the site of their crashed star vessel, it is a much more orderly place than much of the Outer World, though many credit its <br>stability to the region\'s brutal justice system.'
                },
                tagline: 'Bathed in the glory of the Sun Machine, the Blazing Garden is a bold<br>and bombastic place full of larger-than-life characters and creatures.',
                colors: {
                    panelBg: 'linear-gradient(135deg, #5c3a1a 0%, #8a4a1a 50%, #6a3a18 100%)',
                    panelBorder: '#e8a840',
                    titleColor: '#ffd875',
                    taglineColor: '#f5d8a8',
                    accentPrimary: '#f5c040',
                    accentSecondary: '#c87830',
                    imageBorder: '#c8884a'
                },
                images: {
                    landscape: 'Regional Images/page308_Blazing_Garden_image004.png',
                    portraits: [
                        'Regional Images/page308_Blazing_Garden_image001.png',
                        'Regional Images/page308_Blazing_Garden_image002.png',
                        'Regional Images/page308_Blazing_Garden_image003.png'
                    ]
                },
                adventures: [
                    {
                        file: '8-pricklys-situation.html',
                        title: "Prickly's Prickly Situation",
                        sublocation: 'Thunda Sands',
                        location: 'Cereus Plateau',
                        rank: '1-2'
                    },
                    {
                        file: '9-of-cats-and-a-rat.html',
                        title: 'Of Cats and a Rat',
                        sublocation: 'Pride Coast',
                        location: 'Nyanko',
                        rank: '3-4'
                    },
                    {
                        file: '3-thunda-circuit.html',
                        title: 'Thunda Circuit',
                        sublocation: 'Thunda Sands',
                        location: 'Deadstone',
                        rank: '3-4'
                    },
                    {
                        file: '4-crash-landing.html',
                        title: 'Crash Landing!',
                        sublocation: 'No-Folk Land',
                        location: 'Death Valley',
                        rank: '5-6'
                    }
                ]
            },
            'Buried Kingdom': {
                sublocations: ['Old Iron', 'New Ore', 'The Tunnels', 'Lost Crystal', 'Machine Labyrinth'],
                sublocationFlavor: {
                    'Old Iron': 'The ancient dwarven strongholds of Old Iron have stood for millennia, their forges still burning with the flames of forgotten craft. Here the traditionalists cling to the old ways, distrustful of the surface world and its chaos.',
                    'New Ore': 'A sprawling mining operation where opportunists and refugees have carved out a precarious existence. The constant excavation unearths both riches and horrors from the deep.',
                    'The Tunnels': 'An endless maze of passages connecting the disparate settlements of the Underland. Those who know the routes hold power; those who wander lost become prey.',
                    'Lost Crystal': 'Once a magnificent crystalline city of the deep elves, now a shattered ruin haunted by the echoes of its former glory. Treasure seekers brave its dangers for artifacts of immense power.',
                    'Machine Labyrinth': 'A vast complex of gears, pipes, and incomprehensible machinery left behind by some ancient civilization. The automatons that patrol its halls answer to no master.'
                },
                tagline: 'Below the crust of the earth, an endless battle<br>rages in the burrows and caverns of the Underland.',
                colors: {
                    panelBg: 'linear-gradient(135deg, #2a2a2e 0%, #3a3a40 50%, #2a2a2e 100%)',
                    panelBorder: '#7a7a80',
                    titleColor: '#c8c8d0',
                    taglineColor: '#a8a8b0',
                    accentPrimary: '#8a6a4a',
                    accentSecondary: '#5a5a60',
                    imageBorder: '#6a6a70'
                },
                images: {
                    landscape: 'Regional Images/page310_Buried_Kingdom_image001.png',
                    portraits: [
                        'Regional Images/page310_Buried_Kingdom_image002.png',
                        'Regional Images/page310_Buried_Kingdom_image003.png',
                        'Regional Images/page310_Buried_Kingdom_image004.png'
                    ]
                },
                adventures: [
                    // No adventures yet
                ]
            }
        };

        // Flatten structure for loading (sorted by sublocation order within each region)
        function getOrderedAdventures() {
            const ordered = [];
            for (const [region, data] of Object.entries(bookStructure)) {
                // Sort adventures by sublocation order
                const sortedAdventures = [...data.adventures].sort((a, b) => {
                    const aIdx = data.sublocations.indexOf(a.sublocation);
                    const bIdx = data.sublocations.indexOf(b.sublocation);
                    return aIdx - bIdx;
                });
                sortedAdventures.forEach(adv => {
                    ordered.push({ ...adv, region });
                });
            }
            return ordered;
        }

        // Track page numbers for ToC
        const tocData = {}; // Keyed by region
        const frontMatterTocData = []; // For front matter pages
        let currentPageNumber = 1; // Starts at 1 with Introduction

        async function fetchHTML(url) {
            // Add cache-busting to ensure fresh content
            const cacheBuster = `?t=${Date.now()}`;
            const response = await fetch(url + cacheBuster, { cache: 'no-store' });
            return await response.text();
        }

        function extractStyles(html) {
            const styleMatch = html.match(/<style>([\s\S]*?)<\/style>/);
            return styleMatch ? styleMatch[1] : '';
        }

        function extractPages(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            return doc.querySelectorAll('.page');
        }

        // Extract theme colors from adventure CSS for filler pages
        function extractThemeColors(css) {
            const colors = {
                background: null,
                gradientColor1: null,
                gradientColor2: null
            };
            
            // Extract CSS custom properties from :root
            const rootMatch = css.match(/:root\s*\{([^}]+)\}/);
            if (!rootMatch) return colors;
            
            const rootContent = rootMatch[1];
            const varMap = {};
            
            // Parse all CSS variables
            const varMatches = rootContent.matchAll(/--([\w-]+):\s*([^;]+);/g);
            for (const match of varMatches) {
                varMap[`--${match[1]}`] = match[2].trim();
            }
            
            // Find .art-page background
            const artPageMatch = css.match(/\.art-page\s*\{[^}]*background:\s*var\((--[\w-]+)\)/);
            if (artPageMatch && varMap[artPageMatch[1]]) {
                colors.background = varMap[artPageMatch[1]];
            }
            
            // Find .art-page::before gradient colors
            const gradientMatch = css.match(/\.art-page::before\s*\{[^}]*linear-gradient\([^,]+,\s*var\((--[\w-]+)\)\s*,\s*var\((--[\w-]+)\)/);
            if (gradientMatch) {
                colors.gradientColor1 = varMap[gradientMatch[1]] || null;
                colors.gradientColor2 = varMap[gradientMatch[2]] || null;
            }
            
            return colors;
        }

        function scopeStyles(css, scopeClass) {
            // Add scope class to all selectors
            return css.replace(/([^{}]+)(\{[^{}]+\})/g, (match, selector, rules) => {
                // Skip @rules
                if (selector.trim().startsWith('@')) {
                    return match;
                }
                // Skip :root
                if (selector.includes(':root')) {
                    return `.${scopeClass} ${selector.replace(':root', '')} ${rules}`;
                }
                // Scope each selector
                const scopedSelectors = selector.split(',').map(sel => {
                    sel = sel.trim();
                    if (sel.startsWith('@') || sel === '') return sel;
                    return `.${scopeClass} ${sel}`;
                }).join(', ');
                return `${scopedSelectors} ${rules}`;
            });
        }

        // Determines if a page number should be on the left (even pages) or right (odd pages)
        function getPageNumberPosition(pageNum) {
            // Odd pages (1, 3, 5...) are on the right side of the spread
            // Even pages (2, 4, 6...) are on the left side of the spread
            return pageNum % 2 === 0 ? 'page-number-left' : 'page-number-right';
        }

        function createBlankFillerPage() {
            const wrapper = document.createElement('div');
            wrapper.className = 'page-wrapper';
            
            const page = document.createElement('div');
            page.className = 'page blank-filler';
            
            const decoration = document.createElement('div');
            decoration.className = 'filler-decoration';
            page.appendChild(decoration);
            
            const pageNum = document.createElement('div');
            const positionClass = getPageNumberPosition(currentPageNumber);
            pageNum.className = `page-number ${positionClass}`;
            pageNum.textContent = currentPageNumber++;
            
            wrapper.appendChild(page);
            wrapper.appendChild(pageNum);
            
            return wrapper;
        }

        function createPageWrapper(pageElement, options = {}) {
            const { addNumber = true, showNumber = true } = options;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'page-wrapper';
            wrapper.appendChild(pageElement.cloneNode(true));
            
            if (addNumber) {
                if (showNumber) {
                    const pageNum = document.createElement('div');
                    const positionClass = getPageNumberPosition(currentPageNumber);
                    pageNum.className = `page-number ${positionClass}`;
                    pageNum.textContent = currentPageNumber;
                    wrapper.appendChild(pageNum);
                }
                currentPageNumber++;
            }
            
            return wrapper;
        }

        // Create a page wrapper with a pre-assigned page number (for adventure pages)
        function createPageWrapperWithNumber(pageElement, pageNumber) {
            const wrapper = document.createElement('div');
            wrapper.className = 'page-wrapper';
            wrapper.appendChild(pageElement.cloneNode(true));
            
            const pageNum = document.createElement('div');
            const positionClass = getPageNumberPosition(pageNumber);
            pageNum.className = `page-number ${positionClass}`;
            pageNum.textContent = pageNumber;
            wrapper.appendChild(pageNum);
            
            return wrapper;
        }

        // Create a blank filler page with a pre-assigned page number and optional theme colors
        function createBlankFillerWithNumber(pageNumber, themeColors = null) {
            const wrapper = document.createElement('div');
            wrapper.className = 'page-wrapper';
            
            const page = document.createElement('div');
            page.className = 'page blank-filler';
            
            // Apply theme colors if provided
            if (themeColors && themeColors.background) {
                page.classList.add('themed-filler');
                page.style.setProperty('--themed-bg', themeColors.background);
                
                // Apply gradient colors to corner decorators via CSS variables
                if (themeColors.gradientColor1) {
                    page.style.setProperty('--filler-accent-1', themeColors.gradientColor1);
                }
                if (themeColors.gradientColor2) {
                    page.style.setProperty('--filler-accent-2', themeColors.gradientColor2);
                }
            }
            
            const decoration = document.createElement('div');
            decoration.className = 'filler-decoration';
            page.appendChild(decoration);
            
            const pageNum = document.createElement('div');
            const positionClass = getPageNumberPosition(pageNumber);
            pageNum.className = `page-number ${positionClass}`;
            pageNum.textContent = pageNumber;
            
            wrapper.appendChild(page);
            wrapper.appendChild(pageNum);
            
            return wrapper;
        }

        // Toggle page number visibility
        function togglePageNumbers() {
            const checkbox = document.getElementById('showPageNumbers');
            const container = document.getElementById('book-container');
            if (checkbox.checked) {
                container.classList.remove('hide-page-numbers');
            } else {
                container.classList.add('hide-page-numbers');
            }
        }

        // Toggle gradient splash visibility
        function toggleGradientSplash() {
            const checkbox = document.getElementById('showGradientSplash');
            const container = document.getElementById('book-container');
            if (checkbox.checked) {
                container.classList.remove('hide-gradient-splash');
            } else {
                container.classList.add('hide-gradient-splash');
            }
        }

        function createRegionalSeparator(regionName, regionData) {
            const spread = document.createElement('div');
            spread.className = 'spread-container';
            const colors = regionData.colors;
            
            // Shared CSS variables for both pages
            const colorStyles = `
                --region-bg: ${colors.panelBg};
                --title-color: ${colors.titleColor};
                --tagline-color: ${colors.taglineColor};
                --accent-primary: ${colors.accentPrimary};
                --accent-secondary: ${colors.accentSecondary};
                --image-border: ${colors.imageBorder};
            `;
            
            // Left page - decorative only
            const leftWrapper = document.createElement('div');
            leftWrapper.className = 'page-wrapper';
            const leftPage = document.createElement('div');
            leftPage.className = 'region-separator-left';
            leftPage.style.cssText = colorStyles;
            leftWrapper.appendChild(leftPage);
            
            // Add page number to left page
            const leftPageNum = document.createElement('div');
            const leftPositionClass = getPageNumberPosition(currentPageNumber);
            leftPageNum.className = `page-number ${leftPositionClass}`;
            leftPageNum.textContent = currentPageNumber++;
            leftWrapper.appendChild(leftPageNum);
            
            spread.appendChild(leftWrapper);
            
            // Right page - title and images
            const rightWrapper = document.createElement('div');
            rightWrapper.className = 'page-wrapper';
            const rightPage = document.createElement('div');
            rightPage.className = 'region-separator-right';
            rightPage.style.cssText = colorStyles;
            
            rightPage.innerHTML = `
                <div class="region-title">${regionName}</div>
                <div class="region-tagline">${regionData.tagline}</div>
                <div class="region-images">
                    <div class="region-landscape">
                        <img src="${regionData.images.landscape}" alt="${regionName} landscape">
                    </div>
                    <div class="region-portraits">
                        <div class="region-portrait">
                            <img src="${regionData.images.portraits[0]}" alt="${regionName} image 1">
                        </div>
                        <div class="region-portrait">
                            <img src="${regionData.images.portraits[1]}" alt="${regionName} image 2">
                        </div>
                        <div class="region-portrait">
                            <img src="${regionData.images.portraits[2]}" alt="${regionName} image 3">
                        </div>
                    </div>
                </div>
            `;
            
            rightWrapper.appendChild(rightPage);
            
            // Add page number to right page
            const rightPageNum = document.createElement('div');
            const rightPositionClass = getPageNumberPosition(currentPageNumber);
            rightPageNum.className = `page-number ${rightPositionClass}`;
            rightPageNum.textContent = currentPageNumber++;
            rightWrapper.appendChild(rightPageNum);
            
            spread.appendChild(rightWrapper);
            
            return spread;
        }

        function createSubzoneSeparator(subzoneName, flavorText, regionColors) {
            const spread = document.createElement('div');
            spread.className = 'spread-container';
            
            // Create muted/cream-tinted versions of the region colors
            // Mix the accent color with cream for a softer look
            const colorStyles = `
                --subzone-bg: linear-gradient(135deg, #f5f0e6 0%, #ebe6dc 50%, #f5f0e6 100%);
                --subzone-accent: ${regionColors.accentPrimary};
                --subzone-title: ${regionColors.titleColor.replace('#', '')};
                --subzone-text: #4a4540;
            `;
            
            // Adjust title color to be darker for cream background
            const titleColorDark = regionColors.accentSecondary || regionColors.accentPrimary;
            
            // Left page - decorative only (cream with subtle accent)
            const leftWrapper = document.createElement('div');
            leftWrapper.className = 'page-wrapper';
            const leftPage = document.createElement('div');
            leftPage.className = 'subzone-separator-left';
            leftPage.style.cssText = colorStyles;
            leftWrapper.appendChild(leftPage);
            
            // Add page number to left page
            const leftPageNum = document.createElement('div');
            const leftPositionClass = getPageNumberPosition(currentPageNumber);
            leftPageNum.className = `page-number ${leftPositionClass}`;
            leftPageNum.textContent = currentPageNumber++;
            leftWrapper.appendChild(leftPageNum);
            
            spread.appendChild(leftWrapper);
            
            // Right page - subzone name and flavor text
            const rightWrapper = document.createElement('div');
            rightWrapper.className = 'page-wrapper';
            const rightPage = document.createElement('div');
            rightPage.className = 'subzone-separator-right';
            rightPage.style.cssText = colorStyles + `--subzone-title: ${titleColorDark};`;
            
            rightPage.innerHTML = `
                <div class="subzone-title">${subzoneName}</div>
                <div class="subzone-divider"></div>
                <div class="subzone-flavor">${flavorText}</div>
            `;
            
            rightWrapper.appendChild(rightPage);
            
            // Add page number to right page
            const rightPageNum = document.createElement('div');
            const rightPositionClass = getPageNumberPosition(currentPageNumber);
            rightPageNum.className = `page-number ${rightPositionClass}`;
            rightPageNum.textContent = currentPageNumber++;
            rightWrapper.appendChild(rightPageNum);
            
            spread.appendChild(rightWrapper);
            
            return spread;
        }

        function generateToCSpread() {
            const spread = document.createElement('div');
            spread.className = 'spread-container';
            
            // Left TOC page
            const leftWrapper = document.createElement('div');
            leftWrapper.className = 'page-wrapper';
            
            const leftPage = document.createElement('div');
            leftPage.className = 'toc-page toc-page-left';
            leftPage.innerHTML = `
                <div class="toc-header">
                    <h2>Contents</h2>
                    <p class="toc-subtitle">Adventures Across the Outer World</p>
                </div>
                <div class="toc-divider"></div>
                <div class="toc-list" id="toc-list-left"></div>
            `;
            leftWrapper.appendChild(leftPage);
            
            // Add page number to left page
            const leftPageNum = document.createElement('div');
            const leftPositionClass = getPageNumberPosition(currentPageNumber);
            leftPageNum.className = `page-number ${leftPositionClass}`;
            leftPageNum.textContent = currentPageNumber++;
            leftWrapper.appendChild(leftPageNum);
            
            spread.appendChild(leftWrapper);
            
            // Right TOC page
            const rightWrapper = document.createElement('div');
            rightWrapper.className = 'page-wrapper';
            
            const rightPage = document.createElement('div');
            rightPage.className = 'toc-page toc-page-right';
            rightPage.innerHTML = `
                <div class="toc-header">
                    <h2>Contents</h2>
                    <p class="toc-subtitle">Continued</p>
                </div>
                <div class="toc-divider"></div>
                <div class="toc-list" id="toc-list-right"></div>
            `;
            rightWrapper.appendChild(rightPage);
            
            // Add page number to right page
            const rightPageNum = document.createElement('div');
            const rightPositionClass = getPageNumberPosition(currentPageNumber);
            rightPageNum.className = `page-number ${rightPositionClass}`;
            rightPageNum.textContent = currentPageNumber++;
            rightWrapper.appendChild(rightPageNum);
            
            spread.appendChild(rightWrapper);
            
            return spread;
        }

        function populateToC() {
            const tocListLeft = document.getElementById('toc-list-left');
            const tocListRight = document.getElementById('toc-list-right');
            if (!tocListLeft || !tocListRight) return;
            
            // Get region names to split between pages
            const regionNames = Object.keys(bookStructure);
            const midPoint = Math.ceil(regionNames.length / 2);
            const leftRegions = regionNames.slice(0, midPoint);
            const rightRegions = regionNames.slice(midPoint);
            
            // First, add front matter section to left page
            if (frontMatterTocData.length > 0) {
                const frontMatterDiv = document.createElement('div');
                frontMatterDiv.className = 'toc-region toc-front-matter';
                
                frontMatterTocData.forEach(item => {
                    // Main entry
                    const entry = document.createElement('div');
                    entry.className = 'toc-entry';
                    entry.innerHTML = `
                        <span class="toc-title">${item.title}</span>
                        <span class="toc-dots"></span>
                        <span class="toc-page-num">${item.startPage}</span>
                    `;
                    frontMatterDiv.appendChild(entry);
                    
                    // Sub-entries if present
                    if (item.subEntries && item.subEntries.length > 0) {
                        item.subEntries.forEach(sub => {
                            const subEntry = document.createElement('div');
                            subEntry.className = 'toc-entry toc-sub-entry';
                            subEntry.innerHTML = `
                                <span class="toc-title">${sub.title}</span>
                                <span class="toc-dots"></span>
                                <span class="toc-page-num">${sub.page}</span>
                            `;
                            frontMatterDiv.appendChild(subEntry);
                        });
                    }
                });
                
                tocListLeft.appendChild(frontMatterDiv);
            }
            
            // Helper function to create region content
            function createRegionContent(region, targetList) {
                const data = bookStructure[region];
                const regionDiv = document.createElement('div');
                regionDiv.className = 'toc-region';
                
                // Region header
                const header = document.createElement('div');
                header.className = 'toc-region-header';
                header.textContent = region;
                regionDiv.appendChild(header);
                
                // Get adventures for this region from tocData
                const regionAdventures = tocData[region] || [];
                
                // Group adventures by sublocation
                const bySublocaton = {};
                regionAdventures.forEach(adv => {
                    if (!bySublocaton[adv.sublocation]) {
                        bySublocaton[adv.sublocation] = [];
                    }
                    bySublocaton[adv.sublocation].push(adv);
                });
                
                // Output ALL sublocations in order
                data.sublocations.forEach(subloc => {
                    const adventures = bySublocaton[subloc];
                    
                    if (adventures && adventures.length > 0) {
                        // Sublocation with adventures
                        const sublocDiv = document.createElement('div');
                        sublocDiv.className = 'toc-sublocation';
                        sublocDiv.textContent = subloc;
                        regionDiv.appendChild(sublocDiv);
                        
                        // Adventures in this sublocation
                        adventures.forEach(adv => {
                            const entry = document.createElement('div');
                            entry.className = 'toc-entry';
                            const rankHtml = adv.rank ? `<span class="toc-rank">[R${adv.rank}]</span>` : '';
                            entry.innerHTML = `
                                <span class="toc-title">${adv.title}${rankHtml}</span>
                                <span class="toc-dots"></span>
                                <span class="toc-page-num">${adv.startPage}</span>
                            `;
                            regionDiv.appendChild(entry);
                        });
                    } else {
                        // Empty sublocation - show as coming soon
                        const sublocDiv = document.createElement('div');
                        sublocDiv.className = 'toc-sublocation-empty';
                        sublocDiv.textContent = subloc;
                        regionDiv.appendChild(sublocDiv);
                    }
                });
                
                targetList.appendChild(regionDiv);
            }
            
            // Add left page regions
            leftRegions.forEach(region => createRegionContent(region, tocListLeft));
            
            // Add right page regions
            rightRegions.forEach(region => createRegionContent(region, tocListRight));
        }

        async function compileBook() {
            const container = document.getElementById('book-container');
            const status = document.getElementById('status');
            
            container.innerHTML = '';
            // Reset tocData as object keyed by region
            for (const region of Object.keys(bookStructure)) {
                tocData[region] = [];
            }
            // Reset front matter TOC data
            frontMatterTocData.length = 0;
            currentPageNumber = 1;
            
            status.textContent = 'Loading title page...';
            
            try {
                // 1. Load and add title page (solo, no page numbers)
                const titleHtml = await fetchHTML('0-title-page.html');
                const titleStyles = extractStyles(titleHtml);
                const titlePages = extractPages(titleHtml);
                
                const soloSection = document.createElement('div');
                soloSection.className = 'solo-section';
                
                const titleSection = document.createElement('div');
                titleSection.className = 'adventure-section title-section';
                
                const titleStyleEl = document.createElement('style');
                titleStyleEl.textContent = scopeStyles(titleStyles, 'title-section');
                titleSection.appendChild(titleStyleEl);
                
                titlePages.forEach(page => {
                    const wrapper = createPageWrapper(page, { addNumber: true, showNumber: false }); // Count but don't display
                    titleSection.appendChild(wrapper);
                });
                
                soloSection.appendChild(titleSection);
                
                container.appendChild(soloSection);
                
                // 2. Add Table of Contents spread (two pages side-by-side)
                const tocSpread = generateToCSpread();
                container.appendChild(tocSpread);
                
                // 2.5. Load and add Introduction pages as a spread
                status.textContent = 'Loading introduction...';
                const introHtml = await fetchHTML('introduction.html');
                const introStyles = extractStyles(introHtml);
                const introPages = extractPages(introHtml);
                
                // Track for TOC (no sub-entries)
                frontMatterTocData.push({
                    title: 'Introduction',
                    startPage: currentPageNumber,
                    subEntries: []
                });
                
                const introSpread = document.createElement('div');
                introSpread.className = 'spread-container';
                
                introPages.forEach(page => {
                    const introSection = document.createElement('div');
                    introSection.className = 'adventure-section intro-section';
                    
                    const introStyleEl = document.createElement('style');
                    introStyleEl.textContent = scopeStyles(introStyles, 'intro-section');
                    introSection.appendChild(introStyleEl);
                    
                    const wrapper = createPageWrapper(page, { addNumber: true, showNumber: true });
                    introSection.appendChild(wrapper);
                    introSpread.appendChild(introSection);
                });
                
                container.appendChild(introSpread);
                
                // 2.6. Load and add "Using This Book" pages as a spread
                status.textContent = 'Loading guide pages...';
                const guideHtml = await fetchHTML('using-this-book.html');
                const guideStyles = extractStyles(guideHtml);
                const guidePages = extractPages(guideHtml);
                
                // Track for TOC with sub-entries for each page
                const guideStartPage = currentPageNumber;
                frontMatterTocData.push({
                    title: 'Using This Book',
                    startPage: guideStartPage,
                    subEntries: [
                        { title: 'Reading Adventures', page: guideStartPage },
                        { title: 'Adventure Sites', page: guideStartPage + 1 }
                    ]
                });
                
                const guideSpread = document.createElement('div');
                guideSpread.className = 'spread-container';
                
                guidePages.forEach(page => {
                    const guideSection = document.createElement('div');
                    guideSection.className = 'adventure-section guide-section';
                    
                    const guideStyleEl = document.createElement('style');
                    guideStyleEl.textContent = scopeStyles(guideStyles, 'guide-section');
                    guideSection.appendChild(guideStyleEl);
                    
                    const wrapper = createPageWrapper(page, { addNumber: true, showNumber: true });
                    guideSection.appendChild(wrapper);
                    guideSpread.appendChild(guideSection);
                });
                
                container.appendChild(guideSpread);
                
                // 2.7. Load and add Reference Pages as a spread (CLICK! Traps + Adversary Compendium side-by-side)
                status.textContent = 'Loading reference pages...';
                const referenceHtml = await fetchHTML('reference-pages.html');
                const referenceStyles = extractStyles(referenceHtml);
                const referencePages = extractPages(referenceHtml);
                
                // Track for TOC with sub-entries
                const referenceStartPage = currentPageNumber;
                frontMatterTocData.push({
                    title: 'Reference Pages',
                    startPage: referenceStartPage,
                    subEntries: [
                        { title: 'CLICK! Traps', page: referenceStartPage },
                        { title: 'Homebrew Adversary Compendium', page: referenceStartPage + 1 }
                    ]
                });
                
                const referenceSpread = document.createElement('div');
                referenceSpread.className = 'spread-container';
                
                referencePages.forEach(page => {
                    const referenceSection = document.createElement('div');
                    referenceSection.className = 'adventure-section reference-section';
                    
                    const referenceStyleEl = document.createElement('style');
                    referenceStyleEl.textContent = scopeStyles(referenceStyles, 'reference-section');
                    referenceSection.appendChild(referenceStyleEl);
                    
                    const wrapper = createPageWrapper(page, { addNumber: true, showNumber: true });
                    referenceSection.appendChild(wrapper);
                    referenceSpread.appendChild(referenceSection);
                });
                
                container.appendChild(referenceSpread);
                
                // 3. Load adventures by region with regional and subzone separators
                let adventureIndex = 0;
                
                for (const [regionName, regionData] of Object.entries(bookStructure)) {
                    status.textContent = `Adding ${regionName} separator...`;
                    
                    // 3a. Add regional separator spread (no page numbers)
                    const separatorSpread = createRegionalSeparator(regionName, regionData);
                    container.appendChild(separatorSpread);
                    
                    // 3b. Load adventures for this region
                    // Sort adventures by sublocation order
                    const sortedAdventures = [...regionData.adventures].sort((a, b) => {
                        const aIdx = regionData.sublocations.indexOf(a.sublocation);
                        const bIdx = regionData.sublocations.indexOf(b.sublocation);
                        return aIdx - bIdx;
                    });
                    
                    // Track which sublocations we've already added separators for
                    const processedSublocations = new Set();
                    
                    // Collect pages for this region's adventures (including subzone separators)
                    const regionAdventurePages = [];
                    
                    for (const adventure of sortedAdventures) {
                        // Check if we need a subzone separator before this adventure
                        if (!processedSublocations.has(adventure.sublocation)) {
                            processedSublocations.add(adventure.sublocation);
                            
                            // Get flavor text for this sublocation
                            const flavorText = regionData.sublocationFlavor?.[adventure.sublocation] || '';
                            
                            if (flavorText) {
                                status.textContent = `Adding ${adventure.sublocation} separator...`;
                                
                                // Add subzone separator as a spread (2 pages marked as separator type)
                                regionAdventurePages.push({
                                    page: null,
                                    styles: null,
                                    scopeClass: null,
                                    isSubzoneSeparator: true,
                                    subzoneName: adventure.sublocation,
                                    flavorText: flavorText,
                                    regionColors: regionData.colors
                                });
                            }
                        }
                        
                        status.textContent = `Loading ${adventure.title}...`;
                        
                        const html = await fetchHTML(adventure.file);
                        const styles = extractStyles(html);
                        const pages = extractPages(html);
                        
                        const scopeClass = `adventure-${adventureIndex}`;
                        adventureIndex++;
                        
                        // Record start page for ToC
                        tocData[regionName].push({
                            title: adventure.title,
                            sublocation: adventure.sublocation,
                            location: adventure.location,
                            rank: adventure.rank,
                            startPage: currentPageNumber
                        });
                        
                        // Extract theme colors for potential filler pages
                        const themeColors = extractThemeColors(styles);
                        
                        // Add adventure pages with their styles and page numbers
                        pages.forEach(page => {
                            regionAdventurePages.push({
                                page,
                                styles,
                                scopeClass,
                                pageNumber: currentPageNumber++,
                                themeColors: themeColors
                            });
                        });
                        
                        // Pad to 4 pages if only 3 pages
                        if (pages.length === 3) {
                            regionAdventurePages.push({
                                page: null,
                                styles: null,
                                scopeClass: null,
                                pageNumber: currentPageNumber++,
                                themeColors: themeColors  // Use same theme as the adventure
                            });
                        }
                    }
                    
                    // Create spreads for this region's adventures
                    for (let i = 0; i < regionAdventurePages.length; i++) {
                        const pageData = regionAdventurePages[i];
                        
                        // Handle subzone separator spreads
                        if (pageData.isSubzoneSeparator) {
                            const subzoneSeparator = createSubzoneSeparator(
                                pageData.subzoneName,
                                pageData.flavorText,
                                pageData.regionColors
                            );
                            container.appendChild(subzoneSeparator);
                            continue;
                        }
                        
                        // Regular adventure pages - create spreads of 2
                        const spread = document.createElement('div');
                        spread.className = 'spread-container';
                        
                        // Left page
                        const leftPageData = pageData;
                        if (leftPageData.page === null) {
                            spread.appendChild(createBlankFillerWithNumber(leftPageData.pageNumber, leftPageData.themeColors));
                        } else {
                            const leftSection = document.createElement('div');
                            leftSection.className = `adventure-section ${leftPageData.scopeClass}`;
                            const leftStyleEl = document.createElement('style');
                            leftStyleEl.textContent = scopeStyles(leftPageData.styles, leftPageData.scopeClass);
                            leftSection.appendChild(leftStyleEl);
                            leftSection.appendChild(createPageWrapperWithNumber(leftPageData.page, leftPageData.pageNumber));
                            spread.appendChild(leftSection);
                        }
                        
                        // Right page (if exists and not a separator)
                        i++;
                        if (i < regionAdventurePages.length && !regionAdventurePages[i].isSubzoneSeparator) {
                            const rightPageData = regionAdventurePages[i];
                            if (rightPageData.page === null) {
                                spread.appendChild(createBlankFillerWithNumber(rightPageData.pageNumber, rightPageData.themeColors));
                            } else {
                                const rightSection = document.createElement('div');
                                rightSection.className = `adventure-section ${rightPageData.scopeClass}`;
                                const rightStyleEl = document.createElement('style');
                                rightStyleEl.textContent = scopeStyles(rightPageData.styles, rightPageData.scopeClass);
                                rightSection.appendChild(rightStyleEl);
                                rightSection.appendChild(createPageWrapperWithNumber(rightPageData.page, rightPageData.pageNumber));
                                spread.appendChild(rightSection);
                            }
                        } else if (i < regionAdventurePages.length && regionAdventurePages[i].isSubzoneSeparator) {
                            // Found a separator - decrement i so it gets processed next iteration
                            i--;
                        }
                        
                        container.appendChild(spread);
                    }
                }
                
                // 4. Add back cover as final standalone page (no page number, centered like title)
                status.textContent = 'Loading back cover...';
                const backCoverHtml = await fetchHTML('back-cover.html');
                const backCoverStyles = extractStyles(backCoverHtml);
                const backCoverPages = extractPages(backCoverHtml);
                
                if (backCoverPages.length > 0) {
                    const backCoverSolo = document.createElement('div');
                    backCoverSolo.className = 'solo-section';
                    
                    const backCoverSection = document.createElement('div');
                    backCoverSection.className = 'adventure-section back-cover-section';
                    const backStyleEl = document.createElement('style');
                    backStyleEl.textContent = scopeStyles(backCoverStyles, 'back-cover-section');
                    backCoverSection.appendChild(backStyleEl);
                    
                    // Create page wrapper without page number
                    const wrapper = document.createElement('div');
                    wrapper.className = 'page-wrapper back-cover-wrapper';
                    wrapper.appendChild(backCoverPages[0]);
                    backCoverSection.appendChild(wrapper);
                    
                    backCoverSolo.appendChild(backCoverSection);
                    container.appendChild(backCoverSolo);
                }
                
                // 5. Populate ToC with page numbers
                populateToC();
                
                status.textContent = `âœ“ Compiled book with ${Object.keys(bookStructure).length} regions`;

                
            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                console.error(error);
            }
        }

        // Auto-compile on load
        window.addEventListener('DOMContentLoaded', () => {
            compileBook();
        });
    </script>
</body>
</html>